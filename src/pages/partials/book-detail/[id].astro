---
import { getDb } from '../../../lib/db';

const { id } = Astro.params;
const user = Astro.locals.user;
const db = await getDb();
const book = db.data.books.find(b => b.id === id);

if (!book) {
  return new Response('', { status: 404 });
}

const users = db.data.users;
const owner = users.find(u => u.id === book.userId);
const bookedByUser = book.bookedByUserId
  ? users.find(u => u.id === book.bookedByUserId)
  : null;

const isOwner = user?.id === book.userId;
const isBooked = !!book.bookedByUserId;
const isBookedByMe = user ? book.bookedByUserId === user.id : false;
const canBook = user && !isOwner && book.isAvailable && !isBooked;
const canUnbook = isBookedByMe;

const colors = ['#3B82F6', '#8B5CF6', '#EC4899', '#F59E0B', '#10B981', '#EF4444', '#6366F1', '#14B8A6'];
const hash = book.title.split('').reduce((a, c) => a + c.charCodeAt(0), 0);
const coverColor = colors[hash % colors.length];
const initials = book.title.split(' ').slice(0, 2).map(w => w[0]).join('').toUpperCase();

const createdDate = new Date(book.createdAt).toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});
---
<div class="book-detail" id={`book-${book.id}`} hx-get={`/partials/book-detail/${book.id}`} hx-trigger="bookingChanged from:body" hx-swap="outerHTML">
  <div class="book-detail-cover" style={`background: ${coverColor}`}>
    <span class="book-detail-initials">{initials}</span>
    {isBooked && (
      <span class="booked-ribbon">Booked</span>
    )}
  </div>

  <div class="book-detail-content">
    <div class="book-detail-header">
      <h1>{book.title}</h1>
      <p class="book-detail-author">by {book.author}</p>
    </div>

    <div class="book-detail-status">
      {isBooked ? (
        <span class="badge badge-booked">Booked</span>
      ) : book.isAvailable ? (
        <span class="badge badge-green">Available</span>
      ) : (
        <span class="badge badge-gray">Unavailable</span>
      )}
      {isBooked && bookedByUser && (
        <span class="booked-by-info">
          Booked by <strong>{bookedByUser.username}</strong>
        </span>
      )}
    </div>

    {book.description && (
      <div class="book-detail-description">
        <h3>Description</h3>
        <p>{book.description}</p>
      </div>
    )}

    <div class="book-detail-meta">
      <div class="meta-item">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
        <span>Shared by <strong>{owner?.username ?? 'Unknown'}</strong></span>
      </div>
      <div class="meta-item">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
        <span>Added {createdDate}</span>
      </div>
    </div>

    <div class="book-detail-actions">
      {isOwner && (
        <>
          <a href={`/books/edit/${book.id}`} class="btn btn-primary">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
            Edit Book
          </a>
          <button
            class="btn btn-danger"
            hx-delete={`/api/books/${book.id}`}
            hx-confirm="Are you sure you want to delete this book?"
            hx-swap="none"
          >
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
            Delete
          </button>
          {isBooked && (
            <button
              class="btn"
              hx-post={`/api/books/${book.id}/unbook`}
              hx-swap="none"
            >
              Release Booking
            </button>
          )}
        </>
      )}
      {!isOwner && user && (
        <>
          {canBook && (
            <button
              class="btn btn-primary"
              hx-post={`/api/books/${book.id}/book`}
              hx-swap="none"
            >
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/></svg>
              Book this
            </button>
          )}
          {canUnbook && (
            <button
              class="btn"
              hx-post={`/api/books/${book.id}/unbook`}
              hx-swap="none"
            >
              Cancel Booking
            </button>
          )}
          {isBooked && !isBookedByMe && (
            <span class="booked-notice">Someone already booked this book</span>
          )}
        </>
      )}
      {!user && (
        <a href="/login" class="btn btn-primary">Login to book</a>
      )}
    </div>
  </div>
</div>

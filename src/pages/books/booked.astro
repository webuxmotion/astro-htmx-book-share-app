---
import Layout from '../../layouts/Layout.astro';
import BookCard from '../../components/BookCard.astro';
import { getDb } from '../../lib/db';

const user = Astro.locals.user!;
const db = await getDb();
const users = db.data.users;
const bookedBooks = db.data.books
  .filter(b => b.bookedByUserId === user.id)
  .sort((a, b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime())
  .map(book => ({
    ...book,
    username: users.find(u => u.id === book.userId)?.username ?? 'Unknown',
  }));
---
<Layout title="My Bookings">
  <div class="page-header">
    <h2 class="section-heading">My Bookings</h2>
  </div>
  <div id="booked-books-list">
    {bookedBooks.length === 0 ? (
      <div class="empty-state">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" width="64" height="64">
          <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/>
        </svg>
        <p>You haven't booked any books yet.</p>
        <a href="/" class="btn btn-primary" style="margin-top: 1rem;">Browse available books</a>
      </div>
    ) : (
      <div class="book-grid">
        {bookedBooks.map(book => (
          <BookCard book={book} currentUserId={user.id} />
        ))}
      </div>
    )}
  </div>
</Layout>

<style>
  .page-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 2rem;
  }
  .page-header .section-heading {
    margin-bottom: 0;
    text-align: left;
  }
  .page-header .section-heading::after {
    margin: 0.5rem 0 0;
  }
</style>
